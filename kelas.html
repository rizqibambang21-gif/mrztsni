<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masuk Kelas | Teman Belajar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="navbar.css">
    <!-- 1. Import Library QR Scanner dan Firebase -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        /* CSS untuk Modal Absensi */
        .scan-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .scan-box {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        #reader {
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .btn-absen {
            background: #38a169;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-weight: bold;
        }

        /* Spacing untuk konten */
        .content {
            padding-bottom: 50px;
        }
    </style>
    <link rel='stylesheet' href='animations.css'>
</head>

<body>

    <!-- Navbar (Generated by navbar.js) -->
    <script src="navbar.js"></script>

    <div class="content">
        <h1 class="welcome-header">Selamat Datang di Kelas</h1>

        <p id="status-absen"
            style="display:none; text-align: center; font-size: 14px; color: green; margin-bottom: 20px;">✅ Status:
            Sudah Absen Hari Ini</p>

        <p class="welcome-text">Pilih semester dan pertemuan untuk memulai pembelajaran Anda. Mari kita belajar bersama!
        </p>

        <div class="class-layout">
            <div class="semester-menu">
                <h3>Pilih Semester</h3>
                <button class="semester-btn" id="ganjil-btn">Semester Ganjil</button>
                <button class="semester-btn" id="genap-btn">Semester Genap</button>
            </div>

            <div class="pertemuan-section" id="pertemuan-container">
                <h3 id="semester-title">Pilih Semester Terlebih Dahulu</h3>
                <div class="pertemuan-list">
                    <a href="javascript:void(0)" onclick="handlePertemuan('indikator1.html')"
                        class="pertemuan-link">Pertemuan 1</a>
                    <a href="#" class="pertemuan-link">Pertemuan 2</a>
                    <a href="#" class="pertemuan-link">Pertemuan 3</a>
                    <a href="#" class="pertemuan-link">Pertemuan 4</a>
                    <a href="#" class="pertemuan-link">Pertemuan 5</a>
                    <a href="#" class="pertemuan-link">Pertemuan 6</a>
                    <a href="#" class="pertemuan-link">Pertemuan 7</a>
                    <a href="#" class="pertemuan-link">Pertemuan 8</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tombol Tambahan: Sertifikat & Peringkat -->
    <div class="extra-menu"
        style="text-align: center; margin-top: 40px; border-top: 1px solid #e2e8f0; padding-top: 30px;">
        <h3 style="color: #2d3748; margin-bottom: 20px;">Menu Evaluasi Akhir</h3>
        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
            <a href="sertifikat.html" id="btn-sertifikat" class="btn-extra disabled">
                <i class="fa-solid fa-certificate"></i> Klaim Sertifikat
            </a>
            <a href="peringkat.html" id="btn-peringkat" class="btn-extra disabled">
                <i class="fa-solid fa-trophy"></i> Lihat Peringkat
            </a>
        </div>
        <p id="lock-message" style="color: #e53e3e; font-size: 14px; margin-top: 10px; display: none;">
            <i class="fa-solid fa-lock"></i> Selesaikan <a href="quiz-evaluasi.html"
                style="color: #e53e3e; text-decoration: underline;">Quiz Evaluasi</a> (Nilai min. 12) untuk membuka menu
            ini.
        </p>
    </div>
    </div>

    <style>
        .btn-extra {
            background-color: #38a169;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-extra:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-extra.disabled {
            background-color: #cbd5e0;
            color: #718096;
            cursor: not-allowed;
            pointer-events: none;
            box-shadow: none;
        }

        /* Style aktif jika berhasil di-unlock */
        .btn-extra.unlocked {
            background-color: #38a169 !important;
            color: white !important;
            cursor: pointer !important;
            pointer-events: auto !important;
        }
    </style>

    <script>
        // --- 1. Konfigurasi Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBaFa2_d4almWd1wBlmPdzv9aGOa0e0m3A",
            authDomain: "daftarhadit-dfa3a.firebaseapp.com",
            projectId: "daftarhadit-dfa3a",
            storageBucket: "daftarhadit-dfa3a.firebasestorage.app",
            messagingSenderId: "438675023798",
            appId: "1:438675023798:web:3afc376cd435f0154fc317",
            measurementId: "G-XCNLPJSS57"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- 2. Logika Button Unlock (Improved) ---

        function unlockButtons() {
            const btnSertifikat = document.getElementById('btn-sertifikat');
            const btnPeringkat = document.getElementById('btn-peringkat');
            const lockMessage = document.getElementById('lock-message');

            if (btnSertifikat && btnPeringkat) {
                // Hapus disabled, tambah unlocked
                btnSertifikat.classList.remove('disabled');
                btnPeringkat.classList.remove('disabled');

                btnSertifikat.classList.add('unlocked');
                btnPeringkat.classList.add('unlocked');

                if (lockMessage) lockMessage.style.display = 'none';
            }
        }

        const checkQuizStatus = async (user) => {
            if (!user) return;

            // A. FAST CHECK: Cek Session Storage (Agar instan saat Back)
            const cacheKey = 'quiz_passed_' + user.uid;
            if (sessionStorage.getItem(cacheKey) === 'true') {
                unlockButtons();
            }

            try {
                // B. REAL CHECK: Cek Firestore (Langsung ke dokumen User)
                const doc = await db.collection('quiz_results').doc(user.uid).get();

                let isPassed = false;
                if (doc.exists) {
                    const data = doc.data();
                    if (data.skor !== undefined && parseInt(data.skor) >= 12) {
                        isPassed = true;
                    }
                }

                if (isPassed) {
                    unlockButtons();
                    sessionStorage.setItem(cacheKey, 'true'); // Simpan cache
                } else {
                    // Jika belum lulus
                    const btnSertifikat = document.getElementById('btn-sertifikat');
                    const btnPeringkat = document.getElementById('btn-peringkat');
                    const lockMessage = document.getElementById('lock-message');

                    if (btnSertifikat) btnSertifikat.classList.add('disabled');
                    if (btnPeringkat) btnPeringkat.classList.add('disabled');
                    if (lockMessage) lockMessage.style.display = 'block';
                    sessionStorage.removeItem(cacheKey);
                }

            } catch (error) {
                console.error("Gagal cek status kuis:", error);
            }
        };

        // Auth Logic + Page Show Logic
        auth.onAuthStateChanged(user => {
            const authLink = document.getElementById('nav-auth-link');
            if (user) {
                checkQuizStatus(user);
                checkAttendanceToday(user.uid);
                if (authLink) {
                    authLink.textContent = "Logout";
                    authLink.href = "#";
                    authLink.onclick = (e) => { e.preventDefault(); logout(); };
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // HANDLE BACK BUTTON: Jika user kembali dari halaman lain, paksa cek ulang
        window.addEventListener('pageshow', function (event) {
            // Jika halaman diambil dari cache (history traversal)
            if (event.persisted || (window.performance && window.performance.navigation.type === 2) || true) {
                // Kita set true agar SELALU cek saat page show (karena kadang event.persisted false di beberapa browser)
                const user = firebase.auth().currentUser;
                if (user) {
                    checkQuizStatus(user);
                }
            }
        });

        // --- 3. Logika Navbar & Scanner (Existing) ---
        function logout() {
            auth.signOut().then(() => {
                localStorage.removeItem('isLoggedIn');
                sessionStorage.clear(); // Bersihkan cache quiz
                window.location.href = "home.html";
            }).catch((error) => console.error(error));
        }

        // --- 4. Logika Scanner QR ---
        let html5QrcodeScanner;
        let pendingUrl = null;

        function handlePertemuan(url) {
            const user = auth.currentUser;
            if (!user) { alert("Silakan login terlebih dahulu."); return; }
            db.collection('users').doc(user.uid).get().then((userDoc) => {
                if (userDoc.exists && userDoc.data().role === 'guru') { window.location.href = "guru.html"; }
                else { checkStudentAttendance(user, url); }
            }).catch(err => checkStudentAttendance(user, url));
        }

        function checkStudentAttendance(user, url) {
            const today = new Date().toISOString().split('T')[0];
            db.collection('absensi').doc(`${user.uid}_${today}`).get()
                .then((doc) => {
                    if (doc.exists) { window.location.href = url; }
                    else { pendingUrl = url; startScanner(); }
                }).catch(err => alert("Gagal cek status absensi."));
        }

        function startScanner() {
            document.getElementById('scan-modal').style.display = 'flex';
            if (html5QrcodeScanner) html5QrcodeScanner.clear().catch(e => console.error(e));
            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch(err => {
                    html5QrcodeScanner.start({ facingMode: "user" }, config, onScanSuccess, onScanFailure)
                        .catch(err2 => alert("Kamera tidak dapat diakses."));
                });
        }

        function stopScanner() {
            document.getElementById('scan-modal').style.display = 'none';
            if (html5QrcodeScanner) html5QrcodeScanner.stop().then(() => html5QrcodeScanner.clear()).catch(e => { });
        }

        async function onScanSuccess(decodedText) {
            if (decodedText.includes("ABSEN")) { stopScanner(); await prosesAbsensi(decodedText); }
            else { alert("QR Code salah."); }
        }
        function onScanFailure(error) { }

        async function prosesAbsensi(kodeQr) {
            const user = auth.currentUser; if (!user) return;
            const today = new Date().toISOString().split('T')[0];
            const absenRef = db.collection('absensi').doc(`${user.uid}_${today}`);
            try {
                const doc = await absenRef.get();
                if (doc.exists) { alert("Sudah absen hari ini!"); updateStatusDisplay(); }
                else {
                    let nama = user.displayName || user.email;
                    try { const up = await db.collection('users').doc(user.uid).get(); if (up.exists) nama = up.data().nama || nama; } catch (e) { }
                    await absenRef.set({ uid: user.uid, nama: nama, email: user.email, tanggal: today, waktu: new Date().toLocaleString(), kode_qr: kodeQr, status: "Hadir" });
                    alert("Absensi Berhasil!"); updateStatusDisplay();
                    if (pendingUrl) window.location.href = pendingUrl;
                }
            } catch (e) { alert("Gagal absen: " + e.message); }
        }

        function updateStatusDisplay() {
            document.getElementById('status-absen').innerHTML = "✅ Anda sudah absen hari ini.";
            document.getElementById('status-absen').style.color = "green";
        }
        async function checkAttendanceToday(uid) {
            const today = new Date().toISOString().split('T')[0];
            const doc = await db.collection('absensi').doc(`${uid}_${today}`).get();
            if (doc.exists) updateStatusDisplay();
        }
    </script>
    <script src="kelas.js"></script>
    <!-- Modal Scanner -->
    <div id="scan-modal" class="scan-overlay">
        <div class="scan-box">
            <h3>Scan QR Code Guru</h3>
            <div id="reader"></div><button onclick="stopScanner()"
                style="margin-top: 15px; padding: 8px 15px; background: #e53e3e; color: white; border: none; border-radius: 5px;">Tutup</button>
        </div>
    </div>
</body>

</html>